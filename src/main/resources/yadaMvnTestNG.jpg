#!/bin/bash
WORKSPACE=/Users/dvaron/Documents/work
YADA_SRCDIR=$WORKSPACE/YADA
CONTAINER=tomcat
TOMCAT_VERSION=8x
YADA_LOCAL_TOMCAT_HOME=-DYADA.local.tomcat.home=$WORKSPACE/containers/$CONTAINER$TOMCAT_VERSION/
YADA_LOCAL_SQLITE_HOME=-DYADA.local.sqlite.home=$WORKSPACE/YADA/yada-war/src/main/webapp/
YADA_LOCAL_HSQLDB_HOME=-DYADA.local.hsqldb.home=$WORKSPACE/YADA/yada-war/src/main/webapp/
WEBDRIVER_HOME=/Users/dvaron/Documents/work/webdriver
CHROMEDRIVER=-Dwebdriver.chrome.driver=$WEBDRIVER_HOME/chromedriver
GECKODRIVER=-Dwebdriver.gecko.driver=$WEBDRIVER_HOME/geckodriver
WEBDRIVER="$CHROMEDRIVER $GECKODRIVER"
MVN_DEPLOYMENT_GOAL=-Ddeployment.goal=start
LOG=$YADA_SRCDIR/src/main/resources/testng.log
SEC=-Dsecurity.token=YADAYADA
LOG_STDOUT=-Dlog.stdout=true
#PROXY_VARS="-DYADA_PROXY= -DYADA_USER= -DYADA_PASS="
#SKIP_DB_LOAD=-Dskip.db.load=true
SKIP_JAVADOC=-Dmaven.javadoc.skip=true
SKIP_SOURCE=-Dmaven.source.skip=true

COMMON_VARS="$WEBDRIVER \
$SEC \
$LOG_STDOUT \
$YADA_LOCAL_TOMCAT_HOME \
$YADA_LOCAL_SQLITE_HOME \
$YADA_LOCAL_HSQLDB_HOME \
$MVN_DEPLOYMENT_GOAL \
$SKIP_DB_LOAD \
$SKIP_JAVADOC \
$SKIP_SOURCE \
-Ddbload.backup=true"

rm $LOG
cd $YADA_SRCDIR
DEBUG=$1
#mvn $DEBUG clean verify -DskipTests=true
#mvn $DEBUG clean deploy -DskipTests=true
#mvn $DEBUG clean verify -Ptest-pgsql,test-fs,deploy-war -DforkCount=0 $COMMON_VARS >> $LOG
#mvn $DEBUG clean verify -Ptest-pgsql,test-fs,test-proxy,deploy-war ${PROXY_VARS} $COMMON_VARS >> $LOG
mvn $DEBUG clean verify -Ptest-pgsql,deploy-war $COMMON_VARS >> $LOG
#mvn $DEBUG clean verify -Ptest-mysql,deploy-war $COMMON_VARS >> $LOG
#mvn $DEBUG clean verify -Ptest-sqlite,deploy-war $COMMON_VARS >> $LOG
#mvn $DEBUG clean verify -Ptest-hsqldb,deploy-war $COMMON_VARS >> $LOG
#mvn $DEBUG clean verify -Ptest-oracle,deploy-war $COMMON_VARS >> $LOG

perl -e 'while (<>) {chomp;if (/maven-surefire.+\(test|^Tests run.+Time/) {print $_."\n";}}' < $LOG
